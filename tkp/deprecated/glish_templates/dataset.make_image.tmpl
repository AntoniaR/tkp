include 'imager.g'
include 'images.g'

% if averaged:
include 'os.g'
myphasecenter:=dm.direction('J2000', '${ra_phasecenter}','${dec_phasecenter}')  # trans field 
dos.showtableuse ('${path + masterfile}')
imagechanstep := ${imagechanstep}
startspwid := ${startspwid}
while (startspwid < ${startspwid+totspwid}) {
startchan := ${startchan}
while (startchan < ${startchan+totchan}) { 
myim_name := sprintf('${path}d%d_%d.img',startchan,startspwid) 
myim := imager('${path + masterfile}')
myim.setdata(mode='channel',nchan=imagechanstep,spwid=startspwid,fieldid=${fieldid},start=startchan,msselect='FIELD_ID==1 AND sumsqr(UVW[1:2]) > ${min_baseline_squared}')
myim.setimage(nx=${npix},ny=${npix},cellx='${cellsize}',celly='${cellsize}',stokes='I',mode='channel',start=startchan,spwid=startspwid,fieldid=${fieldid})
myim.setoptions(ftmachine='wproject', wprojplanes=128, padding=1.2)
myim.makeimage(type='${imagetype}', image=myim_name)
myim.done()
startchan := startchan + imagechanstep } 
startspwid := startspwid+1 } 
print '\n------ Created all images.  Now start averaging ------ \n' 
startspwid := ${startspwid}
startchan := ${startchan}
myim_name := sprintf('${path}d%d_%d.img',startchan,startspwid) 
average_name := sprintf('davg_avg.img') 
dos.copy(myim_name,average_name) 
im1 := image(average_name) 
dos.remove(myim_name) 
startchan := startchan + imagechanstep 
count := 1 
while (startspwid < ${startspwid+totspwid}) { 
while (startchan < ${startchan+totchan}) { 
myim_name := sprintf('${path}d%d_%d.img',startchan,startspwid) 
im2 := image(myim_name) 
im1.calc('$im1 + $im2') 
count := count + 1 
im2.close() 
dos.remove(myim_name) 
startchan := startchan + imagechanstep } 
startspwid := startspwid + 1 
startchan := ${startchan}} 
im1.close() 
im1 := image(average_name) 
average_str := sprintf('%s/%d',average_name,count)
print count 
im1.calc(average_str) 
im1.tofits(outfile='${filename}') 
im1.close() 
dos.remove('davg_avg.img') 
% else:
dos.showtableuse ('${path + masterfile}')
myim := imager('${path + masterfile}')
myim.setdata(mode='channel',nchan=${totchan},spwid=${spwid},fieldid=${fieldid},start=${startchan},msselect='FIELD_ID==1 AND sumsqr(UVW[1:2]) > ${min_baseline_squared}')
myim.setimage(nx=${npix},ny=${npix},cellx='${cellsize}',celly='${cellsize}',stokes='I',mode='channel',nchan=${outchan},step=${totchan/outchan},start=${startchan},spwid=${spwid},fieldid=${fieldid})
myim.setoptions(ftmachine='wproject', wprojplanes=128, padding=1.2)
myim.makeimage(type='${imagetype}', image='${path + masterfile}.img')
myim.close()
myimg := image('${path + masterfile}.img')
myimg.tofits(outfile='${filename}')
myimg.close()
%endif

exit
